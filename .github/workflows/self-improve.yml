name: Self-Improvement

on:
  workflow_dispatch:
    inputs:
      focus:
        description: 'What should Claude try to improve?'
        required: false
        default: 'general code quality and documentation'
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pull-requests: write

jobs:
  improve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Gather codebase context
        run: |
          echo "# Repository Structure" > /tmp/context.txt
          find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.yml" -o -name "*.md" \) | grep -v node_modules | head -50 >> /tmp/context.txt
          echo "" >> /tmp/context.txt
          for f in README.md CLAUDE_RULES.md; do
            if [ -f "$f" ]; then
              echo "# $f" >> /tmp/context.txt
              head -100 "$f" >> /tmp/context.txt
              echo "" >> /tmp/context.txt
            fi
          done
          echo "# Recent Commits" >> /tmp/context.txt
          git log --oneline -10 >> /tmp/context.txt

      - name: Claude suggests improvements
        id: suggest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FOCUS: ${{ github.event.inputs.focus || 'general code quality' }}
        run: |
          CONTEXT=$(cat /tmp/context.txt | head -c 20000)
          PROMPT="Focus: ${FOCUS}. Context: ${CONTEXT}. Propose ONE small improvement. Respond with ONLY JSON: {\"title\": \"PR title\", \"description\": \"why\", \"files\": [{\"path\": \"file\", \"content\": \"content\"}]}"
          export PROMPT
          python3 -c '
          import json, urllib.request, os
          prompt = os.environ.get("PROMPT", "")
          api_key = os.environ.get("ANTHROPIC_API_KEY", "")
          payload = {"model": "claude-sonnet-4-20250514", "max_tokens": 4096, "messages": [{"role": "user", "content": prompt}]}
          req = urllib.request.Request("https://api.anthropic.com/v1/messages", json.dumps(payload).encode(), {"Content-Type": "application/json", "x-api-key": api_key.strip(), "anthropic-version": "2023-06-01"})
          try:
            with urllib.request.urlopen(req) as r:
              json.dump(json.loads(r.read()), open("/tmp/response.json", "w"))
          except urllib.error.HTTPError as e:
            open("/tmp/response.json", "w").write(e.read().decode())
          '
          RESPONSE=$(cat /tmp/response.json)
          SUGGESTION=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
          if [ -z "$SUGGESTION" ]; then
            echo "No suggestion"; exit 0
          fi
          CLEAN_JSON=$(echo "$SUGGESTION" | sed -n '/^```json/,/^```$/p' | sed '1d;$d')
          [ -z "$CLEAN_JSON" ] && CLEAN_JSON="$SUGGESTION"
          echo "$CLEAN_JSON" > /tmp/suggestion.json
          if ! jq empty /tmp/suggestion.json 2>/dev/null; then
            echo "Invalid JSON"; cat /tmp/suggestion.json; exit 0
          fi
          echo "has_suggestion=true" >> $GITHUB_OUTPUT

      - name: Create improvement PR
        if: steps.suggest.outputs.has_suggestion == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE=$(jq -r '.title' /tmp/suggestion.json)
          DESC=$(jq -r '.description' /tmp/suggestion.json)
          BRANCH="self-improve/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          jq -c '.files[]' /tmp/suggestion.json | while read -r file; do
            FILE_PATH=$(echo "$file" | jq -r '.path')
            CONTENT=$(echo "$file" | jq -r '.content')
            mkdir -p "$(dirname "$FILE_PATH")"
            printf '%s' "$CONTENT" > "$FILE_PATH"
            git add "$FILE_PATH"
          done
          git config user.name "Claude Bot"
          git config user.email "claude@anthropic.com"
          git commit -m "$TITLE" || { echo "Nothing to commit"; exit 0; }
          git push origin "$BRANCH"
          gh pr create --title "$TITLE" --body "## Self-Improvement PR

          $DESC

          ---
          *Auto-generated by Claude.*" --label "auto-merge" || echo "PR creation may have failed"

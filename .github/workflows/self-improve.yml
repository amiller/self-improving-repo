name: Self-Improvement

on:
  workflow_dispatch:
    inputs:
      focus:
        description: 'What should Claude try to improve?'
        required: false
        default: 'general code quality and documentation'
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday midnight

permissions:
  contents: write
  pull-requests: write

jobs:
  improve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Gather codebase context
        run: |
          # Create a summary of the codebase
          echo "# Repository Structure" > /tmp/context.txt
          find . -type f -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.go" -o -name "*.rs" | head -50 >> /tmp/context.txt
          echo "" >> /tmp/context.txt

          # Include key files
          for f in README.md CLAUDE_RULES.md; do
            if [ -f "$f" ]; then
              echo "# $f" >> /tmp/context.txt
              cat "$f" >> /tmp/context.txt
              echo "" >> /tmp/context.txt
            fi
          done

          # Recent commits
          echo "# Recent Commits" >> /tmp/context.txt
          git log --oneline -20 >> /tmp/context.txt

      - name: Claude suggests improvements
        id: suggest
        run: |
          CONTEXT=$(cat /tmp/context.txt | head -c 30000)
          FOCUS="${{ github.event.inputs.focus || 'general code quality' }}"

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d @- <<EOF
          {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 4096,
            "messages": [{
              "role": "user",
              "content": "You are a developer improving this repository. Focus: ${FOCUS}\n\nContext:\n${CONTEXT}\n\nPropose ONE small, specific improvement. Respond in JSON:\n{\"title\": \"PR title\", \"description\": \"what and why\", \"files\": [{\"path\": \"path/to/file\", \"content\": \"full file content\"}]}\n\nKeep changes minimal and focused. Only modify existing files or add small new ones."
            }]
          }
          EOF
          )

          SUGGESTION=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -z "$SUGGESTION" ]; then
            echo "No suggestion generated"
            exit 0
          fi

          echo "$SUGGESTION" > /tmp/suggestion.json

          # Validate it's proper JSON
          if ! jq . /tmp/suggestion.json > /dev/null 2>&1; then
            echo "Invalid JSON response, skipping"
            exit 0
          fi

          echo "has_suggestion=true" >> $GITHUB_OUTPUT

      - name: Create improvement PR
        if: steps.suggest.outputs.has_suggestion == 'true'
        run: |
          TITLE=$(jq -r '.title' /tmp/suggestion.json)
          DESC=$(jq -r '.description' /tmp/suggestion.json)

          # Create branch
          BRANCH="self-improve/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"

          # Apply file changes
          jq -c '.files[]' /tmp/suggestion.json | while read -r file; do
            PATH_=$(echo "$file" | jq -r '.path')
            CONTENT=$(echo "$file" | jq -r '.content')

            mkdir -p "$(dirname "$PATH_")"
            echo "$CONTENT" > "$PATH_"
            git add "$PATH_"
          done

          # Commit and push
          git config user.name "Claude Bot"
          git config user.email "claude@anthropic.com"
          git commit -m "$TITLE" || exit 0
          git push origin "$BRANCH"

          # Create PR with auto-merge label
          gh pr create \
            --title "$TITLE" \
            --body "## ðŸ¤– Self-Improvement PR

$DESC

---
*This PR was automatically generated by Claude. It will be reviewed by the review-pr workflow.*

If approved, it will auto-merge." \
            --label "auto-merge"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

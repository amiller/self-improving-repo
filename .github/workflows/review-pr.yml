name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find PR number
        id: findpr
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --json number -q '.[0].number')
            if [ -z "$PR_NUMBER" ]; then
              echo "No PR found for this branch, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        if: steps.findpr.outputs.skip != 'true'
        id: diff
        run: |
          gh pr diff ${{ steps.findpr.outputs.pr_number }} > /tmp/diff.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Load review rules
        if: steps.findpr.outputs.skip != 'true'
        run: |
          if [ -f "CLAUDE_RULES.md" ]; then
            cat CLAUDE_RULES.md > /tmp/rules.txt
          else
            echo "No special rules. Use good judgment." > /tmp/rules.txt
          fi

      - name: Claude reviews PR
        if: steps.findpr.outputs.skip != 'true'
        id: review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          DIFF=$(cat /tmp/diff.txt | head -c 50000)
          RULES=$(cat /tmp/rules.txt)
          PR_DATA=$(gh pr view ${{ steps.findpr.outputs.pr_number }} --json title,body)
          TITLE=$(echo "$PR_DATA" | jq -r '.title')
          BODY=$(echo "$PR_DATA" | jq -r '.body // ""')

          # Build prompt and export for Python
          export PROMPT="Review this PR.\n\nRules:\n${RULES}\n\nTitle: ${TITLE}\n\nDescription: ${BODY}\n\nDiff:\n${DIFF}\n\nRespond with JSON: {\"decision\": \"APPROVE or REQUEST_CHANGES or COMMENT\", \"summary\": \"one line\", \"details\": \"review details\"}"

          # Use Python for reliable JSON handling
          python3 << 'PYTHON_SCRIPT'
          import json
          import urllib.request
          import os

          prompt = os.environ.get('PROMPT', 'Say hi')
          api_key = os.environ.get('ANTHROPIC_API_KEY', '')

          payload = {
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 1024,
              "messages": [{"role": "user", "content": prompt}]
          }

          data = json.dumps(payload).encode('utf-8')

          req = urllib.request.Request(
              'https://api.anthropic.com/v1/messages',
              data=data,
              headers={
                  'Content-Type': 'application/json',
                  'x-api-key': api_key.strip(),
                  'anthropic-version': '2023-06-01'
              }
          )

          try:
              with urllib.request.urlopen(req) as resp:
                  result = json.loads(resp.read())
                  with open('/tmp/response.json', 'w') as f:
                      json.dump(result, f)
          except urllib.error.HTTPError as e:
              error_body = e.read().decode()
              print(f"Error: {error_body}")
              with open('/tmp/response.json', 'w') as f:
                  f.write(error_body)
          PYTHON_SCRIPT

          RESPONSE=$(cat /tmp/response.json)
          echo "Raw response: $RESPONSE"

          # Check if response is valid JSON
          if ! echo "$RESPONSE" | jq empty 2>/dev/null; then
            echo "Error: Response is not valid JSON"
            echo "$RESPONSE"
            exit 1
          fi

          # Check for error in response
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            echo "API Error: $(echo "$RESPONSE" | jq -r '.error.message')"
            exit 1
          fi

          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
          if [ -z "$REVIEW_TEXT" ]; then
            echo "Error: No review content in response"
            echo "$RESPONSE" | jq .
            exit 1
          fi

          # Claude may wrap JSON in markdown code blocks, extract it
          REVIEW_JSON=$(echo "$REVIEW_TEXT" | sed -n '/^```json/,/^```$/p' | sed '1d;$d')
          if [ -z "$REVIEW_JSON" ]; then
            # Try without code block
            REVIEW_JSON="$REVIEW_TEXT"
          fi

          echo "Extracted JSON: $REVIEW_JSON"

          DECISION=$(echo "$REVIEW_JSON" | jq -r '.decision // "COMMENT"')
          SUMMARY=$(echo "$REVIEW_JSON" | jq -r '.summary // "Review complete"')
          DETAILS=$(echo "$REVIEW_JSON" | jq -r '.details // "No details"')

          echo "decision=$DECISION" >> $GITHUB_OUTPUT

          # Write review body to file to avoid YAML escaping issues
          echo "## Claude Review" > /tmp/review_body.txt
          echo "" >> /tmp/review_body.txt
          echo "Decision: $DECISION" >> /tmp/review_body.txt
          echo "Summary: $SUMMARY" >> /tmp/review_body.txt
          echo "" >> /tmp/review_body.txt
          echo "### Details" >> /tmp/review_body.txt
          echo "$DETAILS" >> /tmp/review_body.txt

      - name: Post review comment
        if: steps.findpr.outputs.skip != 'true'
        run: |
          DECISION="${{ steps.review.outputs.decision }}"
          case "$DECISION" in
            "APPROVE") FLAG="--approve" ;;
            "REQUEST_CHANGES") FLAG="--request-changes" ;;
            *) FLAG="--comment" ;;
          esac
          # Try to post review, fall back to comment if it's own PR
          gh pr review ${{ steps.findpr.outputs.pr_number }} $FLAG --body-file /tmp/review_body.txt || \
            gh pr comment ${{ steps.findpr.outputs.pr_number }} --body-file /tmp/review_body.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge if approved
        if: steps.findpr.outputs.skip != 'true' && steps.review.outputs.decision == 'APPROVE'
        run: |
          LABELS=$(gh pr view ${{ steps.findpr.outputs.pr_number }} --json labels -q '.labels[].name')
          if echo "$LABELS" | grep -q "auto-merge"; then
            gh pr merge ${{ steps.findpr.outputs.pr_number }} --squash --auto
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

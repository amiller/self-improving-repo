name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find PR number
        id: findpr
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --json number -q '.[0].number')
            if [ -z "$PR_NUMBER" ]; then
              echo "No PR found for this branch, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        if: steps.findpr.outputs.skip != 'true'
        id: diff
        run: |
          gh pr diff ${{ steps.findpr.outputs.pr_number }} > /tmp/diff.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Load review rules
        if: steps.findpr.outputs.skip != 'true'
        run: |
          if [ -f "CLAUDE_RULES.md" ]; then
            cat CLAUDE_RULES.md > /tmp/rules.txt
          else
            echo "No special rules. Use good judgment." > /tmp/rules.txt
          fi

      - name: Claude reviews PR
        if: steps.findpr.outputs.skip != 'true'
        id: review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          DIFF=$(cat /tmp/diff.txt | head -c 50000)
          RULES=$(cat /tmp/rules.txt)
          PR_DATA=$(gh pr view ${{ steps.findpr.outputs.pr_number }} --json title,body)
          TITLE=$(echo "$PR_DATA" | jq -r '.title')
          BODY=$(echo "$PR_DATA" | jq -r '.body // ""')

          # Build prompt
          PROMPT="Review this PR.\n\nRules:\n${RULES}\n\nTitle: ${TITLE}\n\nDescription: ${BODY}\n\nDiff:\n${DIFF}\n\nRespond with JSON: {\"decision\": \"APPROVE or REQUEST_CHANGES or COMMENT\", \"summary\": \"one line\", \"details\": \"review details\"}"

          # Build JSON payload with jq
          jq -n --arg content "$PROMPT" '{
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 1024,
            "messages": [{"role": "user", "content": $content}]
          }' > /tmp/payload.json

          # Verify JSON is valid
          if ! jq empty /tmp/payload.json 2>/dev/null; then
            echo "Invalid JSON in payload"
            exit 1
          fi

          # Debug: check API key length
          echo "API key length: ${#ANTHROPIC_API_KEY}"
          echo "Payload file size: $(stat -c%s /tmp/payload.json)"

          # Send to API using file
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -d @/tmp/payload.json)

          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
          if [ -z "$REVIEW" ]; then
            echo "Error: $RESPONSE"
            exit 1
          fi

          DECISION=$(echo "$REVIEW" | jq -r '.decision // "COMMENT"')
          SUMMARY=$(echo "$REVIEW" | jq -r '.summary // "Review complete"')
          DETAILS=$(echo "$REVIEW" | jq -r '.details // "No details"')

          echo "decision=$DECISION" >> $GITHUB_OUTPUT

          # Write review body to file to avoid YAML escaping issues
          echo "## Claude Review" > /tmp/review_body.txt
          echo "" >> /tmp/review_body.txt
          echo "Decision: $DECISION" >> /tmp/review_body.txt
          echo "Summary: $SUMMARY" >> /tmp/review_body.txt
          echo "" >> /tmp/review_body.txt
          echo "### Details" >> /tmp/review_body.txt
          echo "$DETAILS" >> /tmp/review_body.txt

      - name: Post review comment
        if: steps.findpr.outputs.skip != 'true'
        run: |
          DECISION="${{ steps.review.outputs.decision }}"
          case "$DECISION" in
            "APPROVE") EVENT="APPROVE" ;;
            "REQUEST_CHANGES") EVENT="REQUEST_CHANGES" ;;
            *) EVENT="COMMENT" ;;
          esac
          gh pr review ${{ steps.findpr.outputs.pr_number }} --event "$EVENT" --body-file /tmp/review_body.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge if approved
        if: steps.findpr.outputs.skip != 'true' && steps.review.outputs.decision == 'APPROVE'
        run: |
          LABELS=$(gh pr view ${{ steps.findpr.outputs.pr_number }} --json labels -q '.labels[].name')
          if echo "$LABELS" | grep -q "auto-merge"; then
            gh pr merge ${{ steps.findpr.outputs.pr_number }} --squash --auto
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
